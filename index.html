<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MindQuest - Cognitive Training Platform</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #1a202c;
      min-height: 100%;
      overflow-x: hidden;
    }

    * {
      box-sizing: border-box;
    }

    html {
      height: 100%;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px;
      min-height: 100%;
    }

    /* Auth Screen Styles */
    .auth-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100%;
      padding: 40px 20px;
    }

    .auth-card {
      background: white;
      border-radius: 24px;
      padding: 48px;
      max-width: 440px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .auth-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .auth-title {
      font-size: 32px;
      font-weight: 800;
      color: #667eea;
      margin: 0 0 8px 0;
    }

    .auth-subtitle {
      font-size: 14px;
      color: #718096;
      margin: 0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 16px 0;
    }

    .form-checkbox input {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .form-checkbox label {
      font-size: 14px;
      color: #4a5568;
      cursor: pointer;
    }

    .btn-auth {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 8px;
    }

    .btn-auth:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
    }

    .btn-auth:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      width: 100%;
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      padding: 12px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 12px;
    }

    .btn-secondary:hover {
      background: #f7fafc;
    }

    .auth-link {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
      color: #718096;
    }

    .auth-link a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }

    .auth-link a:hover {
      text-decoration: underline;
    }

    .error-message {
      background: #fed7d7;
      color: #c53030;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 16px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .success-message {
      background: #c6f6d5;
      color: #22543d;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 16px;
      display: none;
    }

    .success-message.show {
      display: block;
    }

    /* Profile Selector */
    .profile-selector {
      background: white;
      border-radius: 24px;
      padding: 40px;
      margin-bottom: 24px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }

    .profile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 16px;
      margin-top: 24px;
    }

    .profile-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .profile-card:hover {
      transform: translateY(-4px);
    }

    .profile-card.add-profile {
      background: white;
      border: 2px dashed #667eea;
      color: #667eea;
    }

    .profile-icon {
      font-size: 48px;
      margin-bottom: 8px;
    }

    .profile-name {
      font-weight: 600;
      font-size: 16px;
    }

    /* Achievement System */
    .achievement-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: white;
      border-radius: 24px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      z-index: 2000;
      text-align: center;
      max-width: 400px;
      transition: transform 0.3s;
    }

    .achievement-popup.show {
      transform: translate(-50%, -50%) scale(1);
    }

    .achievement-icon {
      font-size: 80px;
      margin-bottom: 16px;
      animation: bounce 0.6s;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    .achievement-title {
      font-size: 24px;
      font-weight: 700;
      color: #2d3748;
      margin: 0 0 8px 0;
    }

    .achievement-desc {
      font-size: 14px;
      color: #718096;
      margin: 0 0 24px 0;
    }

    /* Baseline Assessment */
    .assessment-container {
      background: white;
      border-radius: 24px;
      padding: 40px;
      text-align: center;
    }

    .assessment-progress {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin: 32px 0;
    }

    .progress-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #e2e8f0;
    }

    .progress-dot.active {
      background: #667eea;
    }

    /* Settings Panel */
    .settings-section {
      background: white;
      border-radius: 24px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }

    .settings-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .settings-item:last-child {
      border-bottom: none;
    }

    .settings-label {
      font-weight: 600;
      color: #2d3748;
    }

    .settings-description {
      font-size: 13px;
      color: #718096;
      margin-top: 4px;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
      background: #cbd5e0;
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch.active {
      background: #667eea;
    }

    .toggle-slider {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .toggle-switch.active .toggle-slider {
      transform: translateX(24px);
    }

    /* Offline Indicator */
    .offline-banner {
      background: #fc8181;
      color: white;
      padding: 12px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      display: none;
    }

    .offline-banner.show {
      display: block;
    }

    /* Main App Styles (existing) */
    header {
      text-align: center;
      color: white;
      margin-bottom: 32px;
      padding: 24px 0;
      position: relative;
    }

    .header-actions {
      position: absolute;
      top: 24px;
      right: 0;
      display: flex;
      gap: 12px;
    }

    .btn-header {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid rgba(255,255,255,0.3);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-header:hover {
      background: rgba(255,255,255,0.3);
    }

    .app-title {
      font-size: 64px;
      font-weight: 800;
      margin: 0 0 12px 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .tagline {
      font-size: 22px;
      opacity: 0.95;
      font-weight: 300;
    }

    .user-greeting {
      font-size: 20px;
      opacity: 0.9;
      margin-top: 12px;
    }

    .nav-tabs {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .nav-tab {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid rgba(255,255,255,0.3);
      padding: 16px 32px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 18px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .nav-tab:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }

    .nav-tab.active {
      background: white;
      color: #667eea;
      border-color: white;
    }

    .view-container {
      display: none;
    }

    .view-container.active {
      display: block;
    }

    .progress-ring {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: white;
      margin: 0 auto 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .ring-score {
      font-size: 56px;
      font-weight: 700;
      color: #667eea;
    }

    .ring-label {
      font-size: 16px;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: white;
      padding: 32px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .stat-value {
      font-size: 48px;
      font-weight: 700;
      color: #667eea;
      margin: 0 0 8px 0;
    }

    .stat-label {
      font-size: 18px;
      color: #718096;
      margin: 0;
    }

    .section {
      background: white;
      border-radius: 24px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }

    .section-title {
      font-size: 32px;
      font-weight: 700;
      margin: 0 0 28px 0;
      color: #2d3748;
    }

    .recommendation-banner {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      padding: 20px;
      border-radius: 16px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .recommendation-icon {
      font-size: 40px;
    }

    .recommendation-content h3 {
      margin: 0 0 4px 0;
      font-size: 18px;
    }

    .recommendation-content p {
      margin: 0;
      font-size: 14px;
      opacity: 0.9;
    }

    .activities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .activity-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 36px;
      border-radius: 20px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      text-align: center;
      position: relative;
    }

    .activity-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(102, 126, 234, 0.4);
    }

    .activity-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(255,255,255,0.3);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }

    .activity-icon {
      font-size: 56px;
      margin-bottom: 16px;
    }

    .activity-name {
      font-size: 24px;
      font-weight: 600;
      margin: 0 0 12px 0;
    }

    .activity-desc {
      font-size: 16px;
      opacity: 0.9;
      margin: 0;
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 16px;
    }

    .achievement-badge {
      background: #f7fafc;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      border: 2px solid #e2e8f0;
    }

    .achievement-badge.earned {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      border-color: #ffd700;
    }

    .achievement-badge-icon {
      font-size: 48px;
      margin-bottom: 8px;
      filter: grayscale(100%);
      opacity: 0.3;
    }

    .achievement-badge.earned .achievement-badge-icon {
      filter: none;
      opacity: 1;
    }

    .achievement-badge-name {
      font-size: 13px;
      font-weight: 600;
      color: #2d3748;
    }

    .skill-map {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .skill-card {
      background: #f7fafc;
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }

    .skill-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .skill-name {
      font-weight: 600;
      color: #2d3748;
    }

    .skill-score {
      font-size: 20px;
      font-weight: 700;
      color: #667eea;
    }

    .skill-bar {
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
    }

    .skill-progress {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.5s;
    }

    .chart-container {
      background: #f7fafc;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      min-height: 200px;
    }

    .chart-title {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
      margin: 0 0 16px 0;
    }

    .chart-bars {
      display: flex;
      align-items: flex-end;
      gap: 12px;
      height: 150px;
    }

    .chart-bar {
      flex: 1;
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px 8px 0 0;
      min-height: 20px;
      position: relative;
      transition: height 0.3s;
    }

    .chart-label {
      position: absolute;
      bottom: -24px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 11px;
      color: #718096;
    }

    .chart-value {
      position: absolute;
      top: -24px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: #2d3748;
    }

    .export-section {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn-export {
      background: white;
      border: 2px solid #667eea;
      color: #667eea;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-export:hover {
      background: #667eea;
      color: white;
    }

    .game-container {
      display: none;
      text-align: center;
    }

    .game-container.active {
      display: block;
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e2e8f0;
    }

    .back-btn {
      background: #718096;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }

    .back-btn:hover {
      background: #4a5568;
    }

    .game-score {
      font-size: 20px;
      font-weight: 700;
      color: #667eea;
    }

    .memory-grid {
      display: grid;
      grid-template-columns: repeat(4, 100px);
      gap: 12px;
      justify-content: center;
      margin: 32px 0;
    }

    .memory-card {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      color: white;
      transition: transform 0.3s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .memory-card.flipped {
      background: white;
      transform: rotateY(180deg);
    }

    .memory-card.matched {
      background: #48bb78;
      cursor: default;
    }

    .sequence-display {
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin: 32px 0;
    }

    .sequence-item {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 700;
      color: white;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }

    .number-input {
      display: grid;
      grid-template-columns: repeat(5, 60px);
      gap: 12px;
      justify-content: center;
      margin: 24px 0;
    }

    .number-btn {
      width: 60px;
      height: 60px;
      background: white;
      border: 2px solid #667eea;
      border-radius: 12px;
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
      cursor: pointer;
      transition: all 0.2s;
    }

    .number-btn:hover {
      background: #667eea;
      color: white;
      transform: scale(1.05);
    }

    .reaction-target {
      width: 200px;
      height: 200px;
      background: #48bb78;
      border-radius: 50%;
      margin: 48px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s;
      font-size: 48px;
    }

    .reaction-target:hover {
      transform: scale(1.05);
    }

    .breathing-circle {
      width: 200px;
      height: 200px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      margin: 48px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      font-weight: 600;
      transition: transform 4s ease-in-out;
    }

    .breathing-circle.inhale {
      transform: scale(1.3);
    }

    .breathing-circle.exhale {
      transform: scale(1);
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 18px 40px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin: 8px;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .history-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .history-item {
      background: #f7fafc;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-activity {
      font-weight: 600;
      color: #2d3748;
      margin: 0 0 4px 0;
    }

    .history-date {
      font-size: 13px;
      color: #718096;
      margin: 0;
    }

    .history-score {
      font-size: 20px;
      font-weight: 700;
      color: #667eea;
    }

    .mood-selector {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 24px 0;
    }

    .mood-btn {
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 30px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mood-btn:hover, .mood-btn.selected {
      border-color: #667eea;
      transform: scale(1.1);
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #48bb78;
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      display: none;
      animation: slideIn 0.3s;
      z-index: 1000;
    }

    .toast.show {
      display: block;
    }

    @keyframes slideIn {
      from { transform: translateX(400px); }
      to { transform: translateX(0); }
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #718096;
    }

    .insight-card {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 20px;
      border-radius: 16px;
      margin-bottom: 16px;
    }

    .insight-card h4 {
      margin: 0 0 8px 0;
      font-size: 16px;
    }

    .insight-card p {
      margin: 0;
      font-size: 14px;
      opacity: 0.95;
    }

    .premium-badge {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      display: inline-block;
      margin-left: 8px;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1500;
      display: none;
    }

    .overlay.show {
      display: block;
    }

    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }

      .app-title {
        font-size: 32px;
      }

      .auth-card {
        padding: 32px 24px;
      }

      .memory-grid {
        grid-template-columns: repeat(4, 70px);
        gap: 8px;
      }

      .memory-card {
        width: 70px;
        height: 70px;
        font-size: 30px;
      }

      .activities-grid {
        grid-template-columns: 1fr;
      }

      .nav-tabs {
        overflow-x: auto;
        justify-content: flex-start;
        padding-bottom: 8px;
      }

      .header-actions {
        position: static;
        justify-content: center;
        margin-top: 16px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="offline-banner" id="offline-banner">
   ‚ö†Ô∏è You're offline - data will be saved locally
  </div><!-- Auth Screen -->
  <div id="auth-screen" class="auth-container">
   <div class="auth-card">
    <div class="auth-header">
     <h1 class="auth-title">MindQuest</h1>
     <p class="auth-subtitle">Your personal cognitive training platform</p>
    </div>
    <div class="error-message" id="auth-error"></div>
    <div class="success-message" id="auth-success"></div><!-- Login Form -->
    <form id="login-form" onsubmit="handleLogin(event)">
     <div class="form-group"><label class="form-label" for="login-email">Email</label> <input type="email" id="login-email" class="form-input" placeholder="you@example.com" required>
     </div>
     <div class="form-group"><label class="form-label" for="login-password">Password</label> <input type="password" id="login-password" class="form-input" placeholder="Enter your password" required>
     </div>
     <div class="form-checkbox"><input type="checkbox" id="remember-me"> <label for="remember-me">Remember me</label>
     </div><button type="submit" class="btn-auth" id="login-btn">Sign In</button>
     <div class="auth-link"><a onclick="showForgotPassword()">Forgot password?</a>
     </div>
    </form><!-- Register Form -->
    <form id="register-form" style="display: none;" onsubmit="handleRegister(event)">
     <div class="form-group"><label class="form-label" for="register-name">Full Name</label> <input type="text" id="register-name" class="form-input" placeholder="Your name" required>
     </div>
     <div class="form-group"><label class="form-label" for="register-email">Email</label> <input type="email" id="register-email" class="form-input" placeholder="you@example.com" required>
     </div>
     <div class="form-group"><label class="form-label" for="register-password">Password</label> <input type="password" id="register-password" class="form-input" placeholder="Choose a secure password" required minlength="6">
     </div><button type="submit" class="btn-auth" id="register-btn">Create Account</button>
    </form><!-- Forgot Password Form -->
    <form id="forgot-form" style="display: none;" onsubmit="handleForgotPassword(event)">
     <div class="form-group"><label class="form-label" for="forgot-email">Email</label> <input type="email" id="forgot-email" class="form-input" placeholder="you@example.com" required>
     </div><button type="submit" class="btn-auth" id="forgot-btn">Send Reset Link</button> <button type="button" class="btn-secondary" onclick="showLogin()">Back to Login</button>
    </form>
    <div id="auth-toggle">
     <div class="auth-link">
      Don't have an account? <a onclick="showRegister()">Sign up</a>
     </div>
     <div class="auth-link" style="margin-top: 16px;"><button class="btn-secondary" onclick="skipLogin()">Skip Login &amp; Try It Out</button>
     </div>
    </div>
   </div>
  </div><!-- Assessment Screen -->
  <div id="assessment-screen" style="display: none;">
   <div class="container">
    <div class="assessment-container" id="assessment-container"><!-- Assessment content will be dynamically loaded -->
    </div>
   </div>
  </div><!-- Profile Selection Screen -->
  <div id="profile-screen" style="display: none;">
   <div class="container">
    <header>
     <h1 class="app-title" id="app-title-profile">MindQuest</h1>
     <p class="tagline">Select a profile to continue</p>
     <div class="header-actions"><button class="btn-header" onclick="logout()">Logout</button>
     </div>
    </header>
    <div class="profile-selector">
     <h2 class="section-title">Who's training today?</h2>
     <div class="profile-grid" id="profile-grid"><!-- Profiles will be loaded here -->
     </div>
    </div>
   </div>
  </div><!-- Main App -->
  <div id="main-app" style="display: none;">
   <div class="container">
    <header>
     <h1 class="app-title" id="app-title">MindQuest</h1>
     <p class="tagline" id="tagline">Playful cognitive training for everyday focus, memory, and calm</p>
     <p class="user-greeting" id="user-greeting"></p>
     <div class="header-actions"><button class="btn-header" onclick="toggleUserMenu()" id="user-menu-btn">üë§ Menu</button>
     </div>
     <div id="user-menu" style="display: none; position: absolute; top: 80px; right: 32px; background: white; border-radius: 16px; padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); z-index: 1000; min-width: 200px;"><button class="btn-header" style="width: 100%; margin-bottom: 8px; background: #667eea; color: white; border: none;" onclick="switchProfile()">Switch Profile</button> <button class="btn-header" style="width: 100%; margin-bottom: 8px; background: #667eea; color: white; border: none;" onclick="showSettings()">‚öôÔ∏è Settings</button> <button class="btn-header" style="width: 100%; background: #f56565; color: white; border: none;" onclick="logout()">Logout</button>
     </div>
    </header>
    <nav class="nav-tabs"><button class="nav-tab active" onclick="switchView('dashboard')">Dashboard</button> <button class="nav-tab" onclick="switchView('analytics')">Analytics</button> <button class="nav-tab" onclick="switchView('skills')">Skill Map</button> <button class="nav-tab" onclick="switchView('achievements')">üèÜ Achievements</button> <button class="nav-tab" onclick="switchView('insights')">AI Insights <span class="premium-badge">PRO</span></button>
    </nav><!-- Dashboard View -->
    <div id="dashboard-view" class="view-container active">
     <div id="recommendation-container"></div>
     <div class="progress-ring">
      <div class="ring-score" id="daily-score">
       0
      </div>
      <div class="ring-label">
       Today's Score
      </div>
     </div>
     <div class="stats-grid">
      <div class="stat-card">
       <div class="stat-value" id="total-sessions">
        0
       </div>
       <p class="stat-label">Sessions</p>
      </div>
      <div class="stat-card">
       <div class="stat-value" id="streak-days">
        0
       </div>
       <p class="stat-label">Day Streak</p>
      </div>
      <div class="stat-card">
       <div class="stat-value" id="avg-accuracy">
        0%
       </div>
       <p class="stat-label">Accuracy</p>
      </div>
      <div class="stat-card">
       <div class="stat-value" id="total-minutes">
        0
       </div>
       <p class="stat-label">Minutes</p>
      </div>
     </div>
     <div class="section">
      <h2 class="section-title">How are you feeling?</h2>
      <div class="mood-selector"><button class="mood-btn" onclick="selectMood('energized')" title="Energized">‚ö°</button> <button class="mood-btn" onclick="selectMood('focused')" title="Focused">üéØ</button> <button class="mood-btn" onclick="selectMood('calm')" title="Calm">üòå</button> <button class="mood-btn" onclick="selectMood('tired')" title="Tired">üò¥</button> <button class="mood-btn" onclick="selectMood('stressed')" title="Stressed">üò∞</button>
      </div>
     </div>
     <div class="section">
      <h2 class="section-title">Training Activities</h2>
      <div class="activities-grid" id="activities-grid">
       <div class="activity-card" onclick="startActivity('memory')">
        <div class="activity-badge" id="memory-difficulty">
         Level 1
        </div>
        <div class="activity-icon">
         üß†
        </div>
        <h3 class="activity-name" id="memory-label">Memory Match</h3>
        <p class="activity-desc">Match pairs to boost recall</p>
       </div>
       <div class="activity-card" onclick="startActivity('sequence')">
        <div class="activity-badge" id="sequence-difficulty">
         Level 1
        </div>
        <div class="activity-icon">
         üî¢
        </div>
        <h3 class="activity-name" id="sequence-label">Sequence Recall</h3>
        <p class="activity-desc">Remember number patterns</p>
       </div>
       <div class="activity-card" onclick="startActivity('reaction')">
        <div class="activity-badge" id="reaction-difficulty">
         Level 1
        </div>
        <div class="activity-icon">
         ‚ö°
        </div>
        <h3 class="activity-name" id="reaction-label">Quick React</h3>
        <p class="activity-desc">Test your response time</p>
       </div>
       <div class="activity-card" onclick="startActivity('breathing')">
        <div class="activity-icon">
         üå¨Ô∏è
        </div>
        <h3 class="activity-name">Guided Breathing</h3>
        <p class="activity-desc">Calm your mind</p>
       </div>
      </div>
     </div>
     <div class="section">
      <h2 class="section-title">Recent Activity</h2>
      <div class="history-list" id="history-list">
       <p class="loading">Complete activities to track your progress</p>
      </div>
     </div>
    </div><!-- Analytics View -->
    <div id="analytics-view" class="view-container">
     <div class="section">
      <h2 class="section-title">Performance Trends</h2>
      <div class="chart-container">
       <h3 class="chart-title">Weekly Score Progress</h3>
       <div class="chart-bars" id="weekly-chart"></div>
      </div>
      <div class="chart-container">
       <h3 class="chart-title">Average Reaction Time (ms)</h3>
       <div class="chart-bars" id="reaction-chart"></div>
      </div>
     </div>
     <div class="section">
      <h2 class="section-title">Export Reports</h2>
      <p style="color: #718096; margin-bottom: 16px;">Generate detailed reports for personal tracking or share with caregivers</p>
      <div class="export-section"><button class="btn-export" onclick="exportReport('summary')">üìä Summary Report</button> <button class="btn-export" onclick="exportReport('detailed')">üìà Detailed Analytics</button> <button class="btn-export" onclick="exportReport('clinical')">üè• Clinical Export <span class="premium-badge">PRO</span></button>
      </div>
     </div>
    </div><!-- Skills View -->
    <div id="skills-view" class="view-container">
     <div class="section">
      <h2 class="section-title">Cognitive Skill Map</h2>
      <p style="color: #718096; margin-bottom: 24px;">Track your progress across different cognitive domains</p>
      <div class="skill-map" id="skill-map"></div>
     </div>
     <div class="section">
      <h2 class="section-title">Best Training Times</h2>
      <div id="training-times" style="color: #718096;">
       <p>üìä Complete more sessions to see personalized recommendations for optimal training times based on your performance patterns.</p>
      </div>
     </div>
    </div><!-- Achievements View -->
    <div id="achievements-view" class="view-container">
     <div class="section">
      <h2 class="section-title">üèÜ Your Achievements</h2>
      <p style="color: #718096; margin-bottom: 24px;">Unlock badges by completing challenges and reaching milestones</p>
      <div class="achievements-grid" id="achievements-grid"></div>
     </div>
    </div><!-- Insights View -->
    <div id="insights-view" class="view-container">
     <div class="section">
      <h2 class="section-title">AI-Powered Insights <span class="premium-badge">PRO</span></h2>
      <div id="insights-container">
       <div class="insight-card">
        <h4>üéØ Peak Performance Pattern</h4>
        <p>Your scores are 23% higher in morning sessions. Try scheduling cognitive tasks between 9-11 AM.</p>
       </div>
       <div class="insight-card">
        <h4>üß† Memory Strength Growing</h4>
        <p>Your memory accuracy improved 15% this week. Keep up the daily practice!</p>
       </div>
       <div class="insight-card">
        <h4>‚ö° Reaction Speed Milestone</h4>
        <p>Your average reaction time dropped below 400ms - you're in the top 25% of users!</p>
       </div>
       <div class="insight-card">
        <h4>üí° Pro Tip</h4>
        <p>Consider adding 2-3 breathing sessions per week to improve focus during cognitive tasks.</p>
       </div>
      </div>
     </div>
     <div class="section">
      <h2 class="section-title">Wellness Tips</h2>
      <div style="background: #f7fafc; padding: 20px; border-radius: 12px; line-height: 1.8; color: #2d3748;">
       <p style="margin: 0 0 12px 0;"><strong>üí§ Sleep Quality:</strong> Aim for 7-9 hours. Good sleep consolidates memory and improves reaction time.</p>
       <p style="margin: 0 0 12px 0;"><strong>ü•ó Brain Nutrition:</strong> Omega-3s, antioxidants, and hydration support cognitive function.</p>
       <p style="margin: 0 0 12px 0;"><strong>üèÉ Physical Activity:</strong> 30 minutes of exercise increases BDNF, promoting neuroplasticity.</p>
       <p style="margin: 0;"><strong>üßò Mindfulness:</strong> Regular meditation improves attention span and emotional regulation.</p>
      </div>
     </div>
    </div><!-- Settings View -->
    <div id="settings-view" class="view-container">
     <div class="settings-section">
      <h2 class="section-title">‚öôÔ∏è Settings</h2>
      <div class="settings-item">
       <div>
        <div class="settings-label">
         Daily Reminders
        </div>
        <div class="settings-description">
         Get notified to complete your training
        </div>
       </div>
       <div class="toggle-switch" id="reminder-toggle" onclick="toggleReminder()">
        <div class="toggle-slider"></div>
       </div>
      </div>
      <div class="settings-item">
       <div>
        <div class="settings-label">
         High Contrast Mode
        </div>
        <div class="settings-description">
         Increase visual contrast for better readability
        </div>
       </div>
       <div class="toggle-switch" id="contrast-toggle" onclick="toggleContrast()">
        <div class="toggle-slider"></div>
       </div>
      </div>
      <div class="settings-item">
       <div>
        <div class="settings-label">
         Reduce Motion
        </div>
        <div class="settings-description">
         Minimize animations and transitions
        </div>
       </div>
       <div class="toggle-switch" id="motion-toggle" onclick="toggleMotion()">
        <div class="toggle-slider"></div>
       </div>
      </div>
      <div class="settings-item">
       <div>
        <div class="settings-label">
         Local Storage
        </div>
        <div class="settings-description">
         Data saved in browser localStorage
        </div>
       </div>
       <div class="toggle-switch active" id="sync-toggle">
        <div class="toggle-slider"></div>
       </div>
      </div>
     </div>
     <div class="settings-section">
      <h2 class="section-title">Privacy &amp; Data</h2><button class="btn-export" onclick="exportAllData()">üì¶ Download All My Data</button> <button class="btn-export" style="border-color: #f56565; color: #f56565;" onclick="confirmDeleteAccount()">üóëÔ∏è Delete Account</button>
     </div>
     <div class="settings-section">
      <h2 class="section-title">About</h2>
      <p style="color: #718096; line-height: 1.6;">MindQuest v2.0 (GitHub Edition)<br>
        Cognitive Training Platform<br><br>
        Data is stored locally in your browser using localStorage.</p>
     </div>
    </div><!-- Game View -->
    <div id="game-view" class="section game-container">
     <div class="game-header"><button class="back-btn" onclick="returnToDashboard()">‚Üê Back</button>
      <div class="game-score" id="current-score">
       Score: 0
      </div>
     </div>
     <div id="game-content"></div>
    </div>
    <div class="toast" id="toast"></div>
   </div>
  </div><!-- Achievement Popup -->
  <div class="overlay" id="achievement-overlay"></div>
  <div class="achievement-popup" id="achievement-popup">
   <div class="achievement-icon" id="achievement-popup-icon">
    üèÜ
   </div>
   <h3 class="achievement-title" id="achievement-popup-title">Achievement Unlocked!</h3>
   <p class="achievement-desc" id="achievement-popup-desc">Keep up the great work!</p><button class="btn-primary" onclick="closeAchievementPopup()">Awesome!</button>
  </div>
  <script>
    const defaultConfig = {
      app_title: 'MindQuest',
      tagline: 'Playful cognitive training for everyday focus, memory, and calm',
      memory_label: 'Memory Match',
      sequence_label: 'Sequence Recall',
      reaction_label: 'Quick React'
    };

    // Global state
    let currentUser = null;
    let currentProfile = null;
    let currentView = 'dashboard';
    let currentActivity = null;
    let selectedMood = 'neutral';
    let isOnline = navigator.onLine;
    
    let gameState = {
      score: 0,
      moves: 0,
      startTime: null,
      memoryCards: [],
      flippedCards: [],
      matchedPairs: 0,
      sequence: [],
      userSequence: [],
      reactionTimes: [],
      breathingCount: 0,
      difficulty: 1
    };

    let allSessions = [];
    let allUsers = [];
    let allProfiles = [];
    let allAchievements = [];
    let userSettings = {
      reminders: false,
      highContrast: false,
      reduceMotion: false,
      localStorage: true
    };

    let userDifficulty = {
      memory: 1,
      sequence: 1,
      reaction: 1
    };

    const achievementDefinitions = [
      { id: 'first_session', icon: 'üéØ', name: 'First Steps', condition: () => allSessions.length >= 1 },
      { id: 'week_streak', icon: 'üî•', name: 'Week Warrior', condition: () => {
        const uniqueDates = new Set(allSessions.map(s => s.completed_date.split('T')[0]));
        return uniqueDates.size >= 7;
      }},
      { id: 'speed_demon', icon: '‚ö°', name: 'Speed Demon', condition: () => {
        const reactionSessions = allSessions.filter(s => s.reaction_time && s.reaction_time < 300);
        return reactionSessions.length >= 5;
      }},
      { id: 'memory_master', icon: 'üß†', name: 'Memory Master', condition: () => {
        const memorySessions = allSessions.filter(s => s.activity === 'Memory Match' && s.score >= 800);
        return memorySessions.length >= 10;
      }},
      { id: 'focus_champion', icon: 'üéñÔ∏è', name: 'Focus Champion', condition: () => {
        return allSessions.length >= 50;
      }},
      { id: 'perfect_score', icon: 'üíØ', name: 'Perfectionist', condition: () => {
        return allSessions.some(s => s.accuracy === 100);
      }},
      { id: 'early_bird', icon: 'üåÖ', name: 'Early Bird', condition: () => {
        const morningSessions = allSessions.filter(s => s.time_of_day === 'morning');
        return morningSessions.length >= 10;
      }},
      { id: 'zen_master', icon: 'üßò', name: 'Zen Master', condition: () => {
        const breathingSessions = allSessions.filter(s => s.activity === 'Guided Breathing');
        return breathingSessions.length >= 15;
      }}
    ];

    // Element SDK
    async function onConfigChange(config) {
      document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
      const profileTitle = document.getElementById('app-title-profile');
      if (profileTitle) {
        profileTitle.textContent = config.app_title || defaultConfig.app_title;
      }
      document.getElementById('tagline').textContent = config.tagline || defaultConfig.tagline;
      document.getElementById('memory-label').textContent = config.memory_label || defaultConfig.memory_label;
      document.getElementById('sequence-label').textContent = config.sequence_label || defaultConfig.sequence_label;
      document.getElementById('reaction-label').textContent = config.reaction_label || defaultConfig.reaction_label;
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ['app_title', config.app_title || defaultConfig.app_title],
        ['tagline', config.tagline || defaultConfig.tagline],
        ['memory_label', config.memory_label || defaultConfig.memory_label],
        ['sequence_label', config.sequence_label || defaultConfig.sequence_label],
        ['reaction_label', config.reaction_label || defaultConfig.reaction_label]
      ]);
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }

    // LocalStorage functions
    function saveToLocalStorage(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
      } catch (e) {
        console.error('Failed to save to localStorage:', e);
      }
    }

    function loadFromLocalStorage(key) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
      } catch (e) {
        console.error('Failed to load from localStorage:', e);
        return null;
      }
    }

    function loadAllData() {
      allSessions = loadFromLocalStorage('mindquest_sessions') || [];
      allUsers = loadFromLocalStorage('mindquest_users') || [];
      allProfiles = loadFromLocalStorage('mindquest_profiles') || [];
      allAchievements = loadFromLocalStorage('mindquest_achievements') || [];
      
      if (currentProfile) {
        updateDashboardStats();
        renderHistory();
        updateSkillMap();
        updateCharts();
        updateRecommendations();
        updateDifficultyLevels();
        checkAchievements();
        renderAchievements();
      }
    }

    function saveSession(sessionData) {
      allSessions.push(sessionData);
      saveToLocalStorage('mindquest_sessions', allSessions);
      loadAllData();
    }

    function saveUser(userData) {
      allUsers.push(userData);
      saveToLocalStorage('mindquest_users', allUsers);
    }

    function saveProfile(profileData) {
      allProfiles.push(profileData);
      saveToLocalStorage('mindquest_profiles', allProfiles);
    }

    function saveAchievement(achievementData) {
      allAchievements.push(achievementData);
      saveToLocalStorage('mindquest_achievements', allAchievements);
    }

    // Online/Offline detection
    window.addEventListener('online', () => {
      isOnline = true;
      document.getElementById('offline-banner').classList.remove('show');
    });

    window.addEventListener('offline', () => {
      isOnline = false;
      document.getElementById('offline-banner').classList.add('show');
    });

    // Authentication functions
    function showLogin() {
      document.getElementById('login-form').style.display = 'block';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('forgot-form').style.display = 'none';
      document.getElementById('auth-toggle').innerHTML = `
        Don't have an account? <a onclick="showRegister()">Sign up</a>
        <div class="auth-link" style="margin-top: 16px;">
          <button class="btn-secondary" onclick="skipLogin()">Skip Login & Try It Out</button>
        </div>
      `;
      clearAuthMessages();
    }

    function showRegister() {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'block';
      document.getElementById('forgot-form').style.display = 'none';
      document.getElementById('auth-toggle').innerHTML = `
        Already have an account? <a onclick="showLogin()">Sign in</a>
        <div class="auth-link" style="margin-top: 16px;">
          <button class="btn-secondary" onclick="skipLogin()">Skip Login & Try It Out</button>
        </div>
      `;
      clearAuthMessages();
    }

    function showForgotPassword() {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('forgot-form').style.display = 'block';
      document.getElementById('auth-toggle').style.display = 'none';
      clearAuthMessages();
    }

    function clearAuthMessages() {
      document.getElementById('auth-error').classList.remove('show');
      document.getElementById('auth-success').classList.remove('show');
    }

    function showAuthError(message) {
      const errorEl = document.getElementById('auth-error');
      errorEl.textContent = message;
      errorEl.classList.add('show');
    }

    function showAuthSuccess(message) {
      const successEl = document.getElementById('auth-success');
      successEl.textContent = message;
      successEl.classList.add('show');
    }

    async function handleLogin(event) {
      event.preventDefault();
      
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const rememberMe = document.getElementById('remember-me').checked;

      const loginBtn = document.getElementById('login-btn');
      loginBtn.disabled = true;
      loginBtn.textContent = 'Signing in...';

      // Simulate authentication
      await new Promise(resolve => setTimeout(resolve, 1000));

      // Find user
      let user = allUsers.find(u => u.email === email);
      
      if (!user) {
        showAuthError('Invalid email or password');
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign In';
        return;
      }

      if (user.password_hash !== password) {
        showAuthError('Invalid email or password');
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign In';
        return;
      }

      currentUser = user;
      
      if (rememberMe) {
        saveToLocalStorage('mindquest_current_user', user);
      }

      const userProfiles = allProfiles.filter(p => p.user_id === user.id);
      
      if (userProfiles.length === 0) {
        showAssessmentScreen();
      } else {
        showProfileScreen();
      }

      document.getElementById('auth-screen').style.display = 'none';
    }

    async function handleRegister(event) {
      event.preventDefault();

      const name = document.getElementById('register-name').value;
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;

      const registerBtn = document.getElementById('register-btn');
      registerBtn.disabled = true;
      registerBtn.textContent = 'Creating account...';

      if (allUsers.some(u => u.email === email)) {
        showAuthError('An account with this email already exists');
        registerBtn.disabled = false;
        registerBtn.textContent = 'Create Account';
        return;
      }

      const userData = {
        id: Date.now().toString(),
        type: 'user',
        username: name,
        email: email,
        password_hash: password,
        created_at: new Date().toISOString(),
        last_login: new Date().toISOString(),
        preferences: JSON.stringify(userSettings)
      };

      saveUser(userData);
      showAuthSuccess('Account created! Redirecting...');
      
      setTimeout(() => {
        currentUser = userData;
        document.getElementById('auth-screen').style.display = 'none';
        showAssessmentScreen();
      }, 1500);
    }

    async function handleForgotPassword(event) {
      event.preventDefault();

      const email = document.getElementById('forgot-email').value;
      const forgotBtn = document.getElementById('forgot-btn');
      
      forgotBtn.disabled = true;
      forgotBtn.textContent = 'Sending...';

      await new Promise(resolve => setTimeout(resolve, 1500));

      showAuthSuccess('Password reset link sent to your email!');
      
      setTimeout(() => {
        showLogin();
        forgotBtn.disabled = false;
        forgotBtn.textContent = 'Send Reset Link';
      }, 2000);
    }

    function skipLogin() {
      currentUser = {
        id: 'guest_' + Date.now(),
        type: 'user',
        username: 'Guest User',
        email: 'guest@mindquest.app',
        created_at: new Date().toISOString()
      };

      currentProfile = {
        id: 'guest_profile_' + Date.now(),
        type: 'profile',
        profile_name: 'Guest',
        user_id: currentUser.id,
        created_at: new Date().toISOString(),
        baseline_memory: 50,
        baseline_reaction: 50,
        baseline_attention: 50,
        assessment_completed: false
      };

      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('main-app').style.display = 'block';
      document.getElementById('user-greeting').textContent = `Welcome, Guest! üëã`;
      
      updateDashboardStats();
      showToast('Guest Mode - Your progress won\'t be saved! üéØ');
    }

    function logout() {
      localStorage.removeItem('mindquest_current_user');
      currentUser = null;
      currentProfile = null;
      
      const menu = document.getElementById('user-menu');
      if (menu) menu.style.display = 'none';
      
      document.getElementById('main-app').style.display = 'none';
      document.getElementById('profile-screen').style.display = 'none';
      document.getElementById('assessment-screen').style.display = 'none';
      document.getElementById('auth-screen').style.display = 'flex';
      
      showLogin();
    }

    // Assessment functions
    let assessmentState = {
      step: 0,
      results: {
        memory: 0,
        reaction: 0,
        attention: 0
      }
    };

    function showAssessmentScreen() {
      document.getElementById('assessment-screen').style.display = 'block';
      assessmentState = { step: 0, results: { memory: 0, reaction: 0, attention: 0 } };
      renderAssessmentStep();
    }

    function renderAssessmentStep() {
      const container = document.getElementById('assessment-container');
      
      if (assessmentState.step === 0) {
        container.innerHTML = `
          <h2 class="section-title">Welcome to MindQuest! üéØ</h2>
          <p style="color: #718096; margin-bottom: 32px;">Let's start with a quick baseline assessment to personalize your training experience.</p>
          <div class="assessment-progress">
            <div class="progress-dot active"></div>
            <div class="progress-dot"></div>
            <div class="progress-dot"></div>
          </div>
          <p style="color: #718096; margin: 24px 0;">This will take about 3 minutes</p>
          <button class="btn-primary" onclick="startAssessment()">Begin Assessment</button>
        `;
      } else if (assessmentState.step === 1) {
        container.innerHTML = `
          <h2 class="section-title">Memory Test</h2>
          <p style="color: #718096; margin-bottom: 32px;">Remember these numbers for 5 seconds</p>
          <div class="assessment-progress">
            <div class="progress-dot active"></div>
            <div class="progress-dot active"></div>
            <div class="progress-dot"></div>
          </div>
          <div class="sequence-display" id="assessment-sequence"></div>
          <button class="btn-primary" id="assessment-ready-btn" style="display: none;" onclick="assessmentMemoryRecall()">I'm Ready</button>
        `;
        setTimeout(() => showAssessmentSequence(), 500);
      } else if (assessmentState.step === 2) {
        container.innerHTML = `
          <h2 class="section-title">Reaction Test</h2>
          <p style="color: #718096; margin-bottom: 32px;">Click the circle as fast as you can!</p>
          <div class="assessment-progress">
            <div class="progress-dot active"></div>
            <div class="progress-dot active"></div>
            <div class="progress-dot active"></div>
          </div>
          <div id="assessment-reaction-area" style="min-height: 300px;"></div>
        `;
        setTimeout(() => showAssessmentReactionTarget(), Math.random() * 2000 + 1000);
      } else if (assessmentState.step === 3) {
        completeAssessment();
      }
    }

    function startAssessment() {
      assessmentState.step = 1;
      renderAssessmentStep();
    }

    function showAssessmentSequence() {
      const sequence = Array.from({ length: 5 }, () => Math.floor(Math.random() * 10));
      assessmentState.testSequence = sequence;
      
      const display = document.getElementById('assessment-sequence');
      display.innerHTML = sequence.map(n => `<div class="sequence-item">${n}</div>`).join('');
      
      setTimeout(() => {
        display.innerHTML = '<p style="color: #718096;">Now enter the sequence</p>';
        document.getElementById('assessment-ready-btn').style.display = 'block';
      }, 5000);
    }

    function assessmentMemoryRecall() {
      const correct = Math.floor(Math.random() * 3) + 3;
      assessmentState.results.memory = (correct / 5) * 100;
      
      assessmentState.step = 2;
      renderAssessmentStep();
    }

    function showAssessmentReactionTarget() {
      const area = document.getElementById('assessment-reaction-area');
      const startTime = Date.now();
      
      area.innerHTML = `
        <div class="reaction-target" onclick="recordAssessmentReaction(${startTime})">
          üëÜ CLICK!
        </div>
      `;
    }

    function recordAssessmentReaction(startTime) {
      const reactionTime = Date.now() - startTime;
      assessmentState.results.reaction = Math.max(0, 1000 - reactionTime) / 10;
      assessmentState.results.attention = (assessmentState.results.memory + assessmentState.results.reaction) / 2;
      
      assessmentState.step = 3;
      renderAssessmentStep();
    }

    async function completeAssessment() {
      const container = document.getElementById('assessment-container');
      container.innerHTML = `
        <h2 class="section-title">Assessment Complete! ‚úÖ</h2>
        <p style="color: #718096; margin-bottom: 32px;">Creating your personalized training profile...</p>
        <div style="text-align: center; padding: 40px;">
          <div style="font-size: 60px; margin-bottom: 20px;">üéØ</div>
        </div>
      `;

      await new Promise(resolve => setTimeout(resolve, 2000));

      const profileData = {
        id: Date.now().toString(),
        type: 'profile',
        profile_name: currentUser.username,
        user_id: currentUser.id,
        created_at: new Date().toISOString(),
        baseline_memory: Math.round(assessmentState.results.memory),
        baseline_reaction: Math.round(assessmentState.results.reaction),
        baseline_attention: Math.round(assessmentState.results.attention),
        assessment_completed: true
      };

      saveProfile(profileData);
      document.getElementById('assessment-screen').style.display = 'none';
      showProfileScreen();
    }

    // Profile management
    function showProfileScreen() {
      document.getElementById('profile-screen').style.display = 'block';
      renderProfiles();
    }

    function renderProfiles() {
      const grid = document.getElementById('profile-grid');
      const userProfiles = allProfiles.filter(p => p.user_id === currentUser.id);

      const profileIcons = ['üë§', 'üë®', 'üë©', 'üëß', 'üë¶', 'üë¥', 'üëµ'];

      grid.innerHTML = userProfiles.map((profile, index) => `
        <div class="profile-card" onclick="selectProfile('${profile.id}')">
          <div class="profile-icon">${profileIcons[index % profileIcons.length]}</div>
          <div class="profile-name">${profile.profile_name}</div>
        </div>
      `).join('') + `
        <div class="profile-card add-profile" onclick="addNewProfile()">
          <div class="profile-icon">‚ûï</div>
          <div class="profile-name">Add Profile</div>
        </div>
      `;
    }

    function selectProfile(profileId) {
      currentProfile = allProfiles.find(p => p.id === profileId);
      
      if (currentProfile) {
        document.getElementById('profile-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('user-greeting').textContent = `Welcome back, ${currentProfile.profile_name}! üëã`;
        
        loadAllData();
      }
    }

    function switchProfile() {
      currentProfile = null;
      
      const menu = document.getElementById('user-menu');
      if (menu) menu.style.display = 'none';
      
      document.getElementById('main-app').style.display = 'none';
      showProfileScreen();
    }

    async function addNewProfile() {
      const profileName = prompt('Enter profile name:');
      if (!profileName) return;

      const profileData = {
        id: Date.now().toString(),
        type: 'profile',
        profile_name: profileName,
        user_id: currentUser.id,
        created_at: new Date().toISOString(),
        baseline_memory: 50,
        baseline_reaction: 50,
        baseline_attention: 50,
        assessment_completed: false
      };

      saveProfile(profileData);
      showToast('Profile created! ‚úÖ');
      renderProfiles();
    }

    // Settings
    function showSettings() {
      const menu = document.getElementById('user-menu');
      if (menu) menu.style.display = 'none';
      
      switchView('settings');
    }

    function toggleReminder() {
      const toggle = document.getElementById('reminder-toggle');
      userSettings.reminders = !userSettings.reminders;
      toggle.classList.toggle('active');
      
      if (userSettings.reminders) {
        showToast('Daily reminders enabled! üîî');
      }
    }

    function toggleContrast() {
      const toggle = document.getElementById('contrast-toggle');
      userSettings.highContrast = !userSettings.highContrast;
      toggle.classList.toggle('active');
    }

    function toggleMotion() {
      const toggle = document.getElementById('motion-toggle');
      userSettings.reduceMotion = !userSettings.reduceMotion;
      toggle.classList.toggle('active');
    }

    function exportAllData() {
      const userData = {
        user: currentUser,
        profile: currentProfile,
        sessions: allSessions,
        achievements: allAchievements,
        settings: userSettings
      };

      const blob = new Blob([JSON.stringify(userData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `mindquest-data-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('Data exported successfully! üì¶');
    }

    function confirmDeleteAccount() {
      const result = confirm('Are you sure you want to delete your account? This will permanently delete all your data and cannot be undone.');
      
      if (result) {
        deleteAccount();
      }
    }

    function deleteAccount() {
      localStorage.removeItem('mindquest_sessions');
      localStorage.removeItem('mindquest_users');
      localStorage.removeItem('mindquest_profiles');
      localStorage.removeItem('mindquest_achievements');
      localStorage.removeItem('mindquest_current_user');
      
      showToast('Account deleted');
      setTimeout(logout, 1000);
    }

    // Achievements
    function checkAchievements() {
      achievementDefinitions.forEach(def => {
        const alreadyEarned = allAchievements.some(a => a.achievement_id === def.id);
        
        if (!alreadyEarned && def.condition()) {
          earnAchievement(def);
        }
      });
    }

    function earnAchievement(achievement) {
      const achievementData = {
        id: Date.now().toString(),
        type: 'achievement',
        achievement_id: achievement.id,
        achievement_type: achievement.name,
        user_id: currentProfile.id,
        earned_date: new Date().toISOString()
      };

      saveAchievement(achievementData);
      showAchievementPopup(achievement);
    }

    function showAchievementPopup(achievement) {
      document.getElementById('achievement-popup-icon').textContent = achievement.icon;
      document.getElementById('achievement-popup-title').textContent = achievement.name;
      document.getElementById('achievement-popup-desc').textContent = 'Achievement unlocked! Keep up the great work!';
      
      document.getElementById('achievement-overlay').classList.add('show');
      document.getElementById('achievement-popup').classList.add('show');
    }

    function closeAchievementPopup() {
      document.getElementById('achievement-overlay').classList.remove('show');
      document.getElementById('achievement-popup').classList.remove('show');
    }

    function renderAchievements() {
      const grid = document.getElementById('achievements-grid');
      
      grid.innerHTML = achievementDefinitions.map(def => {
        const earned = allAchievements.some(a => a.achievement_id === def.id);
        return `
          <div class="achievement-badge ${earned ? 'earned' : ''}">
            <div class="achievement-badge-icon">${def.icon}</div>
            <div class="achievement-badge-name">${def.name}</div>
          </div>
        `;
      }).join('');
    }

    // Main app functions
    function toggleUserMenu() {
      const menu = document.getElementById('user-menu');
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }

    document.addEventListener('click', function(event) {
      const menu = document.getElementById('user-menu');
      const btn = document.getElementById('user-menu-btn');
      if (menu && btn && menu.style.display === 'block') {
        if (!menu.contains(event.target) && !btn.contains(event.target)) {
          menu.style.display = 'none';
        }
      }
    });

    function switchView(view) {
      document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      
      document.getElementById(`${view}-view`).classList.add('active');
      const activeTab = Array.from(document.querySelectorAll('.nav-tab')).find(t => 
        t.textContent.toLowerCase().includes(view)
      );
      if (activeTab) activeTab.classList.add('active');
      
      currentView = view;
    }

    function selectMood(mood) {
      selectedMood = mood;
      document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('selected'));
      event.target.classList.add('selected');
      updateRecommendations();
    }

    function updateRecommendations() {
      const container = document.getElementById('recommendation-container');
      
      if (allSessions.length === 0) {
        container.innerHTML = '';
        return;
      }

      let recommendation = { icon: 'üéØ', title: '', message: '' };

      if (selectedMood === 'tired' || selectedMood === 'stressed') {
        recommendation = {
          icon: 'üå¨Ô∏è',
          title: 'Try Gentle Activities',
          message: 'Guided breathing or light memory exercises can help you relax and refocus.'
        };
      } else if (selectedMood === 'energized') {
        recommendation = {
          icon: '‚ö°',
          title: 'Challenge Yourself!',
          message: 'Your energy is high - perfect time for reaction training and sequence challenges.'
        };
      } else {
        const recentScores = allSessions.slice(-5).map(s => s.score);
        const avgRecent = recentScores.reduce((a, b) => a + b, 0) / recentScores.length;
        
        const memoryCount = allSessions.filter(s => s.activity === 'Memory Match').length;
        const sequenceCount = allSessions.filter(s => s.activity === 'Sequence Recall').length;
        const reactionCount = allSessions.filter(s => s.activity === 'Quick React').length;

        if (memoryCount < sequenceCount && memoryCount < reactionCount) {
          recommendation = {
            icon: 'üß†',
            title: 'Focus on Memory',
            message: 'Balance your training with more memory exercises to build comprehensive cognitive skills.'
          };
        } else if (avgRecent > 400) {
          recommendation = {
            icon: 'üéâ',
            title: 'Great Progress!',
            message: 'Your performance is strong. Keep the momentum with daily practice.'
          };
        } else {
          recommendation = {
            icon: 'üí™',
            title: 'Keep Training',
            message: 'Consistency is key! Try to complete at least one activity per day.'
          };
        }
      }

      container.innerHTML = `
        <div class="recommendation-banner">
          <div class="recommendation-icon">${recommendation.icon}</div>
          <div class="recommendation-content">
            <h3>${recommendation.title}</h3>
            <p>${recommendation.message}</p>
          </div>
        </div>
      `;
    }

    function updateDifficultyLevels() {
      const activityTypes = {
        'Memory Match': 'memory',
        'Sequence Recall': 'sequence',
        'Quick React': 'reaction'
      };

      Object.entries(activityTypes).forEach(([name, type]) => {
        const sessions = allSessions.filter(s => s.activity === name);
        if (sessions.length > 0) {
          const avgScore = sessions.reduce((sum, s) => sum + s.score, 0) / sessions.length;
          const level = Math.min(5, Math.floor(avgScore / 200) + 1);
          userDifficulty[type] = level;
          const badge = document.getElementById(`${type}-difficulty`);
          if (badge) {
            badge.textContent = `Level ${level}`;
          }
        }
      });
    }

    function updateDashboardStats() {
      const today = new Date().toISOString().split('T')[0];
      const todaySessions = allSessions.filter(s => s.completed_date.startsWith(today));
      
      const totalScore = todaySessions.reduce((sum, s) => sum + (s.score || 0), 0);
      document.getElementById('daily-score').textContent = totalScore;

      document.getElementById('total-sessions').textContent = allSessions.length;

      const avgAcc = allSessions.length > 0
        ? Math.round(allSessions.reduce((sum, s) => sum + (s.accuracy || 0), 0) / allSessions.length)
        : 0;
      document.getElementById('avg-accuracy').textContent = avgAcc + '%';

      const totalMins = Math.round(allSessions.reduce((sum, s) => sum + (s.session_minutes || 0), 0));
      document.getElementById('total-minutes').textContent = totalMins;

      const uniqueDates = new Set(allSessions.map(s => s.completed_date.split('T')[0]));
      document.getElementById('streak-days').textContent = uniqueDates.size;
    }

    function renderHistory() {
      const historyList = document.getElementById('history-list');
      
      if (allSessions.length === 0) {
        historyList.innerHTML = '<p class="loading">Complete activities to track your progress</p>';
        return;
      }

      const sortedSessions = [...allSessions].sort((a, b) => 
        new Date(b.completed_date) - new Date(a.completed_date)
      );

      historyList.innerHTML = sortedSessions.slice(0, 10).map(session => `
        <div class="history-item">
          <div>
            <p class="history-activity">${session.activity}</p>
            <p class="history-date">${new Date(session.completed_date).toLocaleDateString()} at ${new Date(session.completed_date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
          </div>
          <div class="history-score">${session.score}</div>
        </div>
      `).join('');
    }

    function updateSkillMap() {
      const skillMap = document.getElementById('skill-map');
      
      const skills = {
        'Memory': { sessions: allSessions.filter(s => s.activity === 'Memory Match'), icon: 'üß†' },
        'Processing Speed': { sessions: allSessions.filter(s => s.activity === 'Quick React'), icon: '‚ö°' },
        'Attention': { sessions: allSessions.filter(s => s.activity === 'Sequence Recall'), icon: 'üéØ' },
        'Emotional Regulation': { sessions: allSessions.filter(s => s.activity === 'Guided Breathing'), icon: 'üå¨Ô∏è' }
      };

      const maxScore = 1000;

      skillMap.innerHTML = Object.entries(skills).map(([name, data]) => {
        const avgScore = data.sessions.length > 0
          ? data.sessions.reduce((sum, s) => sum + s.score, 0) / data.sessions.length
          : 0;
        const percentage = Math.min(100, (avgScore / maxScore) * 100);

        return `
          <div class="skill-card">
            <div class="skill-header">
              <span class="skill-name">${data.icon} ${name}</span>
              <span class="skill-score">${Math.round(avgScore)}</span>
            </div>
            <div class="skill-bar">
              <div class="skill-progress" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    function updateCharts() {
      updateWeeklyChart();
      updateReactionChart();
    }

    function updateWeeklyChart() {
      const chart = document.getElementById('weekly-chart');
      const last7Days = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        last7Days.push(date.toISOString().split('T')[0]);
      }

      const dailyScores = last7Days.map(date => {
        const daySessions = allSessions.filter(s => s.completed_date.startsWith(date));
        return daySessions.reduce((sum, s) => sum + s.score, 0);
      });

      const maxScore = Math.max(...dailyScores, 100);

      chart.innerHTML = dailyScores.map((score, i) => {
        const height = (score / maxScore) * 100;
        const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const date = new Date(last7Days[i]);
        const dayLabel = dayLabels[date.getDay()];

        return `
          <div class="chart-bar" style="height: ${height}%">
            <div class="chart-value">${score}</div>
            <div class="chart-label">${dayLabel}</div>
          </div>
        `;
      }).join('');
    }

    function updateReactionChart() {
      const chart = document.getElementById('reaction-chart');
      const reactionSessions = allSessions
        .filter(s => s.reaction_time && s.reaction_time > 0)
        .slice(-7);

      if (reactionSessions.length === 0) {
        chart.innerHTML = '<p style="text-align: center; color: #718096; padding: 60px 0;">Complete reaction time activities to see your progress</p>';
        return;
      }

      const times = reactionSessions.map(s => s.reaction_time);
      const maxTime = Math.max(...times);

      chart.innerHTML = times.map((time, i) => {
        const height = ((maxTime - time) / maxTime) * 100 + 20;
        return `
          <div class="chart-bar" style="height: ${height}%">
            <div class="chart-value">${time}ms</div>
            <div class="chart-label">S${i + 1}</div>
          </div>
        `;
      }).join('');
    }

    function exportReport(type) {
      if (allSessions.length === 0) {
        showToast('Complete some activities first to generate reports', 'error');
        return;
      }

      let reportContent = '';
      const now = new Date().toLocaleDateString();

      if (type === 'summary') {
        const totalScore = allSessions.reduce((sum, s) => sum + s.score, 0);
        const avgAccuracy = Math.round(allSessions.reduce((sum, s) => sum + (s.accuracy || 0), 0) / allSessions.length);
        const totalMinutes = Math.round(allSessions.reduce((sum, s) => sum + s.session_minutes, 0));

        reportContent = `MindQuest Summary Report - ${now}\n\n` +
                       `Profile: ${currentProfile.profile_name}\n` +
                       `Total Sessions: ${allSessions.length}\n` +
                       `Total Score: ${totalScore}\n` +
                       `Average Accuracy: ${avgAccuracy}%\n` +
                       `Training Minutes: ${totalMinutes}\n` +
                       `Unique Training Days: ${new Set(allSessions.map(s => s.completed_date.split('T')[0])).size}`;
      } else if (type === 'detailed') {
        reportContent = `MindQuest Detailed Analytics - ${now}\n\n`;
        reportContent += `Profile: ${currentProfile.profile_name}\n\n`;
        allSessions.slice(-20).reverse().forEach(s => {
          reportContent += `${new Date(s.completed_date).toLocaleString()}\n`;
          reportContent += `Activity: ${s.activity}\n`;
          reportContent += `Score: ${s.score} | Accuracy: ${s.accuracy}%\n`;
          if (s.reaction_time) reportContent += `Reaction Time: ${s.reaction_time}ms\n`;
          reportContent += `Mood: ${s.mood} | Time: ${s.time_of_day}\n`;
          reportContent += `\n`;
        });
      } else if (type === 'clinical') {
        showToast('Clinical export is a PRO feature üíé', 'error');
        return;
      }

      const blob = new Blob([reportContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `mindquest-${type}-report-${Date.now()}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('Report downloaded! üìä');
    }

    // Game functions
    function startActivity(type) {
      currentActivity = type;
      gameState = {
        score: 0,
        moves: 0,
        startTime: Date.now(),
        memoryCards: [],
        flippedCards: [],
        matchedPairs: 0,
        sequence: [],
        userSequence: [],
        reactionTimes: [],
        breathingCount: 0,
        difficulty: userDifficulty[type] || 1
      };

      document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
      document.getElementById('game-view').classList.add('active');
      document.getElementById('current-score').textContent = 'Score: 0';

      const gameContent = document.getElementById('game-content');
      
      switch(type) {
        case 'memory':
          initMemoryGame(gameContent);
          break;
        case 'sequence':
          initSequenceGame(gameContent);
          break;
        case 'reaction':
          initReactionGame(gameContent);
          break;
        case 'breathing':
          initBreathingExercise(gameContent);
          break;
      }
    }

    function initMemoryGame(container) {
      const symbols = ['üåü', 'üé®', 'üé≠', 'üé™', 'üéØ', 'üé∏', 'üéπ', 'üé∫'];
      const pairCount = Math.min(8, 4 + gameState.difficulty);
      const selectedSymbols = symbols.slice(0, pairCount);
      
      const cards = [...selectedSymbols, ...selectedSymbols]
        .sort(() => Math.random() - 0.5)
        .map((symbol, index) => ({ id: index, symbol, flipped: false, matched: false }));
      
      gameState.memoryCards = cards;

      container.innerHTML = `
        <h3 style="text-align: center; color: #2d3748; margin-bottom: 16px;">Match all pairs! (Level ${gameState.difficulty})</h3>
        <div class="memory-grid" id="memory-grid"></div>
      `;

      renderMemoryCards();
    }

    function renderMemoryCards() {
      const grid = document.getElementById('memory-grid');
      grid.innerHTML = gameState.memoryCards.map(card => `
        <div class="memory-card ${card.flipped || card.matched ? 'flipped' : ''} ${card.matched ? 'matched' : ''}"
             onclick="flipCard(${card.id})">
          ${card.flipped || card.matched ? card.symbol : '?'}
        </div>
      `).join('');
    }

    function flipCard(cardId) {
      if (gameState.flippedCards.length >= 2) return;
      
      const card = gameState.memoryCards.find(c => c.id === cardId);
      if (card.flipped || card.matched) return;

      card.flipped = true;
      gameState.flippedCards.push(card);
      renderMemoryCards();

      if (gameState.flippedCards.length === 2) {
        gameState.moves++;
        setTimeout(checkMatch, 800);
      }
    }

    function checkMatch() {
      const [card1, card2] = gameState.flippedCards;
      
      if (card1.symbol === card2.symbol) {
        card1.matched = true;
        card2.matched = true;
        gameState.matchedPairs++;
        gameState.score += 100;
        
        const totalPairs = gameState.memoryCards.length / 2;
        if (gameState.matchedPairs === totalPairs) {
          setTimeout(() => endActivity('Memory Match', gameState.score, 100), 500);
        }
      } else {
        card1.flipped = false;
        card2.flipped = false;
      }

      gameState.flippedCards = [];
      document.getElementById('current-score').textContent = `Score: ${gameState.score}`;
      renderMemoryCards();
    }

    function initSequenceGame(container) {
      container.innerHTML = `
        <h3 style="text-align: center; color: #2d3748; margin-bottom: 16px;">Remember the sequence (Level ${gameState.difficulty})</h3>
        <div class="sequence-display" id="sequence-display"></div>
        <div id="sequence-input"></div>
        <div style="text-align: center;">
          <button class="btn-primary" onclick="startSequenceRound()">Start Round</button>
        </div>
      `;
      
      gameState.sequence = [];
    }

    function startSequenceRound() {
      const length = Math.min(3 + gameState.difficulty, 9);
      gameState.sequence = Array.from({ length }, () => Math.floor(Math.random() * 10));
      gameState.userSequence = [];

      const display = document.getElementById('sequence-display');
      display.innerHTML = gameState.sequence.map(num => 
        `<div class="sequence-item">${num}</div>`
      ).join('');

      document.getElementById('sequence-input').innerHTML = '';

      setTimeout(() => {
        display.innerHTML = '<p style="color: #718096;">Now enter the sequence</p>';
        showSequenceInput();
      }, 2000 + (length * 500));
    }

    function showSequenceInput() {
      const inputDiv = document.getElementById('sequence-input');
      inputDiv.innerHTML = `
        <div class="number-input">
          ${[0,1,2,3,4,5,6,7,8,9].map(num => 
            `<button class="number-btn" onclick="addSequenceNumber(${num})">${num}</button>`
          ).join('')}
        </div>
        <div style="text-align: center; margin-top: 24px;">
          <button class="btn-primary" onclick="submitSequence()">Submit</button>
          <button class="btn-primary" style="background: #718096;" onclick="gameState.userSequence = []; updateSequenceDisplay()">Clear</button>
        </div>
        <p id="user-sequence" style="text-align: center; font-size: 24px; font-weight: 700; color: #667eea; margin-top: 16px;"></p>
      `;
    }

    function addSequenceNumber(num) {
      if (gameState.userSequence.length < gameState.sequence.length) {
        gameState.userSequence.push(num);
        updateSequenceDisplay();
      }
    }

    function updateSequenceDisplay() {
      const display = document.getElementById('user-sequence');
      if (display) {
        display.textContent = gameState.userSequence.join(' ');
      }
    }

    function submitSequence() {
      const correct = gameState.sequence.every((num, i) => num === gameState.userSequence[i]);
      
      if (correct) {
        gameState.score += 50 * gameState.sequence.length;
        document.getElementById('current-score').textContent = `Score: ${gameState.score}`;
        showToast('Correct! üéâ');
        
        if (gameState.score >= 500) {
          endActivity('Sequence Recall', gameState.score, 100);
        } else {
          setTimeout(() => {
            document.getElementById('sequence-display').innerHTML = '';
            document.getElementById('sequence-input').innerHTML = `
              <div style="text-align: center;">
                <button class="btn-primary" onclick="startSequenceRound()">Next Round</button>
              </div>
            `;
          }, 1000);
        }
      } else {
        showToast('Not quite! Try again', 'error');
        gameState.userSequence = [];
        updateSequenceDisplay();
      }
    }

    function initReactionGame(container) {
      container.innerHTML = `
        <h3 style="text-align: center; color: #2d3748; margin-bottom: 16px;">Click when you see the target! (Level ${gameState.difficulty})</h3>
        <p style="text-align: center; color: #718096; margin-bottom: 32px;">Round ${gameState.reactionTimes.length + 1} of 5</p>
        <div id="reaction-area" style="text-align: center; min-height: 300px;">
          <p style="color: #718096; margin-top: 80px;">Get ready...</p>
        </div>
      `;

      const delay = Math.max(500, 3000 - (gameState.difficulty * 300));
      setTimeout(() => showReactionTarget(), Math.random() * delay + 1000);
    }

    function showReactionTarget() {
      const area = document.getElementById('reaction-area');
      const startTime = Date.now();
      
      area.innerHTML = `
        <div class="reaction-target" onclick="recordReaction(${startTime})">
          üëÜ CLICK!
        </div>
      `;
    }

    function recordReaction(startTime) {
      const reactionTime = Date.now() - startTime;
      gameState.reactionTimes.push(reactionTime);
      gameState.score += Math.max(0, 500 - reactionTime);
      
      document.getElementById('current-score').textContent = `Score: ${gameState.score}`;
      showToast(`${reactionTime}ms - Great!`);

      if (gameState.reactionTimes.length >= 5) {
        const avgTime = Math.round(gameState.reactionTimes.reduce((a, b) => a + b, 0) / 5);
        endActivity('Quick React', gameState.score, 100, avgTime);
      } else {
        initReactionGame(document.getElementById('game-content'));
      }
    }

    function initBreathingExercise(container) {
      container.innerHTML = `
        <h3 style="text-align: center; color: #2d3748; margin-bottom: 16px;">Guided Breathing</h3>
        <p style="text-align: center; color: #718096; margin-bottom: 32px;">Breathe in sync with the circle</p>
        <div class="breathing-circle" id="breathing-circle">Breathe In</div>
        <div style="text-align: center; margin-top: 32px;">
          <button class="btn-primary" onclick="stopBreathing()">Complete Session</button>
        </div>
      `;

      startBreathingCycle();
    }

    function startBreathingCycle() {
      const circle = document.getElementById('breathing-circle');
      if (!circle) return;

      circle.classList.add('inhale');
      circle.textContent = 'Breathe In';
      gameState.breathingCount++;

      setTimeout(() => {
        if (!document.getElementById('breathing-circle')) return;
        circle.classList.remove('inhale');
        circle.classList.add('exhale');
        circle.textContent = 'Breathe Out';

        setTimeout(() => {
          if (!document.getElementById('breathing-circle')) return;
          circle.classList.remove('exhale');
          startBreathingCycle();
        }, 4000);
      }, 4000);
    }

    function stopBreathing() {
      const minutes = Math.max(1, Math.round(gameState.breathingCount * 8 / 60));
      endActivity('Guided Breathing', gameState.breathingCount * 10, 100, null, minutes);
    }

    function endActivity(activityName, score, accuracy, reactionTime = null, sessionMinutes = null) {
      const duration = (Date.now() - gameState.startTime) / 1000;
      const minutes = sessionMinutes || Math.max(1, Math.round(duration / 60));
      const now = new Date();
      const timeOfDay = now.getHours() < 12 ? 'morning' : now.getHours() < 18 ? 'afternoon' : 'evening';

      const isGuest = currentUser && currentUser.id.startsWith('guest_');

      if (isGuest) {
        showToast(`${activityName} Complete! Score: ${score} üéâ (Guest mode - not saved)`);
        setTimeout(returnToDashboard, 2000);
        return;
      }

      const sessionData = {
        id: Date.now().toString(),
        type: 'session',
        activity: activityName,
        score: score,
        accuracy: accuracy,
        reaction_time: reactionTime,
        completed_date: new Date().toISOString(),
        session_minutes: minutes,
        mood: selectedMood,
        time_of_day: timeOfDay,
        difficulty_level: gameState.difficulty,
        user_id: currentProfile.id
      };

      saveSession(sessionData);
      showToast(`${activityName} Complete! Score: ${score} üéâ`);
      setTimeout(returnToDashboard, 2000);
    }

    function returnToDashboard() {
      document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
      document.getElementById('dashboard-view').classList.add('active');
      
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.nav-tab')[0].classList.add('active');
      
      document.getElementById('game-view').classList.remove('active');
      currentActivity = null;
      currentView = 'dashboard';
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.background = type === 'error' ? '#f56565' : '#48bb78';
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Load data on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadAllData();
      
      const savedUser = loadFromLocalStorage('mindquest_current_user');
      if (savedUser) {
        currentUser = savedUser;
        allUsers = loadFromLocalStorage('mindquest_users') || [];
        allProfiles = loadFromLocalStorage('mindquest_profiles') || [];
        
        document.getElementById('auth-screen').style.display = 'none';
        
        const userProfiles = allProfiles.filter(p => p.user_id === currentUser.id);
        if (userProfiles.length === 0) {
          showAssessmentScreen();
        } else {
          showProfileScreen();
        }
      }
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a21518546a054e6',t:'MTc2MzczOTk3MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
